{% extends "./base.html" %}

{% import "./macros.html" as macros %}

{% block head%}
    {{ super() }}
    <!-- Local Stylesheet -->
    <link rel="stylesheet" href="{{url_for('static', filename='profile.css')}}">
{% endblock %}

{% block display_title %}Profile{% endblock %}

{% block nav_content %}
    {% if g.user != None %}
        <div class="prof-card mx-auto justify-content-center">
            <div class="pfp-container">
                <img src="{{url_for('static', filename=g.user[4].strip('.'))}}" class="pfp-lg card-image-top"/>
                <div class="change-pfp pfp-lg">
                    <i class="fa fa-camera fa-4"></i>
                    <form id="pfp-form" method="POST" enctype="multipart/form-data" action="{{url_for('profile')}}">
                        <input name="pfp" id="pfp-chooser" type="file"/>
                    </form>
                </div>
            </div>
            <br>
            <h5 class="card-title">{{g.user[1]}}</h5>
            <a href="{{url_for('profile')}}" class="btn btn-primary">Profile</a>
            <a href="{{url_for('auth.sign_out')}}" class="btn min-button"><i class="fa fa-sign-out"></i></a>
        </div>
    {% else %}
        <button class="nav-button login-button" onclick="Display_Overlay()"> Sign In </button>
    {% endif %}
    <div class="side-nav">
    <!-- Navigation Buttons -->
    <a class="nav-button" href="#" onclick="Show_Post_Creator()">Create Post</a>
    <br>
    <a class="nav-button" href="{{url_for('dashboard')}}">Dashboard</a>
    </div>
{% endblock %}

{% block main_content %}
    <div class="create-post hidden">
        <div class="row">
            <div class="col-lg-12 p-2 d-flex">
                <div class="card mx-auto">
                    <div class="card-body">
                        <form class="post-body" id="post-creation-form" method="POST" action="javascript:void(0);">

                            <!-- Quill Editor -->
                            <div onkeydown='ValidatePost()' id="post-body" name="postContent" required></div>
                            <div id="toolbar">
                                <span class="ql-formats">
                                    <button class="ql-bold"></button>
                                    <button class="ql-italic"></button>
                                    <button class="ql-underline"></button>
                                    <button class="ql-strike"></button>
                                </span>
                                <span class="ql-formats">
                                    <select class="ql-align"></select>
                                </span>
                                <span class="ql-format-group">
                                  <select title="Size" class="ql-size">
                                    <option value="10px">Small</option>
                                    <option value="13px">Normal</option>
                                    <option value="18px">Large</option>
                                    <option value="32px">Huge</option>
                                  </select>
                                </span>
                                <span class="ql-formats">
                                    <button class="ql-image"></button>
                                </span>
                                <input id="post-submit" onclick="SubmitForm()" type="submit" value="Create Post">
                                <span id="counter" style="color:green">0/255</span> 
                                <span id="flashed-error"></span>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="posts">
        {% for post in posts %}
            <div class="row">
                <div class="col-lg-12 p-2 d-flex">
                    <div class="card mx-auto">
                        <div class="card-body">
                            <h5 class="card-title"><img class="pfp" src="{{url_for('static', filename=post[-5].strip('.'))}}" />        {{ post[1] }}</h5>
                            <div class="post-display">
                                <div>
                                    <p class="card-text">{{ post[4] |safe}}</p>
                                </div>
                                <a 
                                    onclick="Show_Reply_Creator(this)"
                                    class="action-link {{post[0]}}"
                                >
                                    <i class="fa fa-reply" aria-hidden="true"></i>
                                </a>
                                <a 
                                    href="#" 
                                    class="action-link {{post[0]}} like-button {% if post[0] in activated_posts[0]%}activated{% endif %}"
                                >
                                    <i class="fa fa-thumbs-up {{post[0]}}" aria-hidden="true"></i>  {{post[-4]}}
                                </a> 
                                <a 
                                    href="#"
                                    class="action-link {{post[0]}} dislike-button {% if post[0] in activated_posts[1]%}activated{% endif %}"
                                >
                                    <i class="fa fa-thumbs-down {{post[0]}}" aria-hidden="true"></i>  {{post[-3]}}
                                </a>

                                {% if post[-1]|length > 0 %}
                                <button onclick="Show_Replies({{post[0]}})">Show {{ post[-1]|length }} Replies </button>
                                {% endif %}

                                <a 
                                    href="{{url_for('delete_post', post_id=post[0])}}"
                                    class="action-link"
                                >
                                    <i class="fa fa-trash-o" aria-hidden="true"></i>
                                </a>

                                <a 
                                    href="#"
                                    class="action-link {{post[0]}} edit-button"
                                >
                                    <i class="fa fa-edit" aria-hidden="true"></i>
                                </a>
                            </div>
                            <div class="post-editor hidden">
                                <form class="{{post[0]}}" method="POST" action="javascript:void(0);">
                                    <!-- Quill Editor -->
                                    <div oninput="ValidatePost()" id="post-body{{post[0]}}" name="postContent" required></div>
                                    <div id="toolbar{{post[0]}}">
                                        <span id="counter" style="color:green">0/255</span> 
                                        <span class="ql-formats">
                                            <button class="ql-bold"></button>
                                            <button class="ql-italic"></button>
                                            <button class="ql-underline"></button>
                                            <button class="ql-strike"></button>
                                        </span>
                                        <span class="ql-formats">
                                            <select class="ql-align"></select>
                                        </span>
                                        <input id="post-submit{{post[0]}}" class="{{post[0]}}" onclick="SubmitEdits(this)" type="submit" value="Create Post">
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {{ macros.reply_editor(post) }}
            <div class="reply-container minimised" id="replies-{{post[0]}}">
                <!-- Display each reply to each post -->
                {% for reply in post[-1]%}

                    {{ macros.display_reply(reply, activated_posts) }}

                {% endfor %}
            </div>
        {% endfor %}
    </div>
{% endblock %}

{% block scripts %}
{{ super() }}

<script>

    var editor = new Quill('#post-body', {
        modules: { toolbar: '#toolbar' },
        theme: 'snow',
    });

    var post_editors = {}

    $('#post-creation-form').submit(function(e) {
        let post_body = editor.root.innerHTML;
        let pure_text = editor.root.innerText;

        if (pure_text.length > 0) {
            $.ajax(
                {
                    data:{post_content: post_body, reply_id: 0, stripped_content: pure_text},
                    type: 'POST',
                    url:"{{url_for('create_post')}}"
                }
            )
            .done(
                function(result){
                    if (result.error == null) {
                        location.reload();
                    } else {
                        document.getElementById('flashed-error').innerHTML = result.error;
                    }
                }
            )
        } else {
            e.preventDefault()
            console.log('post creation blocked')
        }
    });

    $(document).ready(function() {
        $('#pfp-chooser').on('change', function() {
            document.getElementById('pfp-form').submit();
            /*
            var pfp_data = new FormData();
            var pfp_chooser = document.getElementById('pfp-chooser');
            pfp_data.append('pfp', pfp_chooser.files[0]);

            $.ajax({
                url: '{{url_for("profile")}}',
                type: 'POST',
                processData: false, // important
                contentType: false, // important
                dataType : 'json',
                data: pfp_data
            })
            .done( function(data) {
                if (data.success) {
                    window.location.href = window.location.href;
                }
            }
            );
            */
        });
    });

    function EditPost(button) {
        console.log('gelp')
        let post_display = button.parentElement;
        let post_editor = post_display.nextElementSibling;
        let postID = button.classList[1];
        
        post_display.classList.add('hidden')
        post_editor.classList.remove('hidden')
        let editor = new Quill(`#post-body${postID}`, {
            modules: { toolbar: `#toolbar${postID}` },
            theme: 'snow',
        });
        post_editors[postID] = editor
    }
    $('.edit-button').on('click', function() {
        let post_display = $(this).parent();
        let post_editor = post_display.next();
        let postID = $(this).attr('class').split(/\s+/)[1];
        
        post_display.addClass('hidden')
        post_editor.removeClass('hidden')
        let editor = new Quill(`#post-body${postID}`, {
            modules: { toolbar: `#toolbar${postID}` },
            theme: 'snow',
        });
        post_editors[postID] = editor
    })

    function SubmitEdits(submit_button) {
        let content = post_editors[submit_button.classList[0]].root.innerHTML
        let post_editor = post_editors[submit_button.classList[0]].root.parentElement.parentElement.parentElement
        let post_display = post_editor.previousElementSibling

        console.log(post_display.firstChild.nextElementSibling)

        $.ajax(
            {   
                data: {
                    post_content: content,
                    post_id: submit_button.classList[0]
                },
                type: 'POST',
                url: '{{url_for("update_post")}}'
            }
        )
        .done(
            function(result) {
                post_display.firstChild.nextElementSibling.innerHTML = result.content
                post_display.classList.remove('hidden')
                post_editor.classList.add('hidden')
                post_editors[submit_button.classList[0]].root.innerHTML = ""
            }
        )
    }

</script>
{% endblock %}
</html>